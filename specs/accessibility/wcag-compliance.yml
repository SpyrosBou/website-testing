# WCAG 2.1 AA Compliance Testing Specification
# Comprehensive accessibility testing using @axe-core/playwright

metadata:
  category: "accessibility"
  version: "1.0.0"
  description: "WCAG 2.1 AA compliance testing using industry-standard tools"
  priority: "critical"
  dependencies: ["test-helpers", "site-loader", "@axe-core/playwright"]
  tags:
    - "accessibility"
    - "wcag-2.1"
    - "axe-core"
    - "inclusive-design"

configuration:
  timeout: 45000  # Extended for accessibility scanning
  retries: 1      # Accessibility tests are usually consistent
  parallel: true
  browsers: ["chrome", "firefox", "safari"]
  axe_configuration:
    include_tags: ["wcag2a", "wcag2aa", "wcag21aa"]
    exclude_tags: ["experimental"]
    impact_levels: ["critical", "serious", "moderate", "minor"]
    fail_on: ["critical", "serious"]  # Only fail on critical/serious violations

test_cases:
  - name: "automated_accessibility_scanning"
    description: "Run automated accessibility scans using axe-core"
    priority: "critical"
    allure:
      epic: "Accessibility"
      feature: "WCAG Compliance"
      story: "As a user with disabilities, I want accessible web content"
      severity: "critical"
    
    execution:
      for_each_page: "{{siteConfig.testPages}}"
      conditions:
        - response_status: 200
      steps:
        - action: "navigate_safely"
          target: "{{baseUrl}}{{currentPage}}"
          description: "Navigate to {{currentPage}}"
        
        - action: "wait_for_page_stability"
          strategies: ["domcontentloaded", "networkidle"]
          timeout: 15000
          description: "Ensure page is fully loaded before scanning"
        
        - action: "run_axe_accessibility_scan"
          configuration:
            tags: ["wcag2a", "wcag2aa", "wcag21aa"]
            rules: "default"  # Use default axe rules
            include_experimental: false
          timeout: 30000
          description: "Run comprehensive accessibility scan"
        
        - action: "analyze_violation_results"
          categorization:
            critical_violations:
              - impact: "critical"
              - action: "fail_test"
              - report_level: "error"
            serious_violations:
              - impact: "serious"
              - action: "fail_test"
              - report_level: "error"
            moderate_violations:
              - impact: "moderate"
              - action: "log_warning"
              - report_level: "warning"
            minor_violations:
              - impact: "minor"
              - action: "log_info"
              - report_level: "info"
          description: "Analyze and categorize accessibility violations"
        
        - action: "generate_accessibility_report"
          include:
            - violation_summary: true
            - remediation_guidance: true
            - help_urls: true
            - affected_elements: true
          format: "allure_attachment"
          description: "Generate detailed accessibility report"

  - name: "keyboard_navigation_testing"
    description: "Test keyboard navigation and focus management"
    priority: "high"
    allure:
      epic: "Accessibility"
      feature: "Keyboard Navigation"
      story: "As a keyboard user, I want to navigate using only the keyboard"
      severity: "normal"
    
    execution:
      for_each_page: "{{siteConfig.testPages}}"
      limit: 5  # Test representative sample
      steps:
        - action: "test_tab_navigation"
          navigation_pattern:
            - start_from: "body"
            - tab_through_all_focusable: true
            - verify_tab_order: true
            - check_focus_visibility: true
            - ensure_no_focus_traps: true
          max_tab_stops: 50  # Reasonable limit
          description: "Test tab navigation through page elements"
        
        - action: "test_keyboard_shortcuts"
          shortcuts:
            - key: "Enter"
              targets: "buttons, links"
              expected: "activation"
            - key: "Space"
              targets: "buttons, checkboxes"
              expected: "activation"
            - key: "Escape"
              targets: "modals, dropdowns"
              expected: "close"
            - key: "ArrowKeys"
              targets: "menus, tabs"
              expected: "navigation"
          description: "Test keyboard shortcuts and interactions"
        
        - action: "test_skip_links"
          check_for:
            - skip_to_content: "a[href='#content'], a[href='#main']"
            - skip_to_navigation: "a[href='#navigation'], a[href='#nav']"
            - skip_to_search: "a[href='#search']"
          validate:
            - links_functional: true
            - targets_exist: true
            - focus_moves_correctly: true
          description: "Test skip links functionality"

  - name: "semantic_structure_validation"
    description: "Validate semantic HTML structure and ARIA implementation"
    priority: "high"
    allure:
      epic: "Accessibility"
      feature: "Semantic Structure"
      story: "As a screen reader user, I want properly structured content"
      severity: "normal"
    
    execution:
      for_each_page: "{{siteConfig.testPages}}"
      steps:
        - action: "validate_heading_structure"
          checks:
            - h1_present: true
            - h1_unique: true
            - heading_hierarchy: true  # No skipped levels
            - heading_content: "not_empty"
          description: "Validate heading structure and hierarchy"
        
        - action: "validate_landmark_regions"
          required_landmarks:
            - "main": 1  # Exactly one main landmark
            - "navigation": ">=1"  # At least one nav
            - "banner": "<=1"  # Zero or one banner
            - "contentinfo": "<=1"  # Zero or one footer
          optional_landmarks:
            - "search"
            - "complementary"
            - "region"
          description: "Validate ARIA landmark regions"
        
        - action: "validate_aria_implementation"
          aria_checks:
            - aria_labels_meaningful: true
            - aria_describedby_valid: true
            - aria_expanded_accurate: true
            - aria_hidden_appropriate: true
            - role_usage_correct: true
          description: "Validate ARIA attributes and roles"
        
        - action: "validate_form_accessibility"
          if: "forms_present"
          form_checks:
            - labels_associated: true
            - fieldsets_for_groups: true
            - error_messages_linked: true
            - required_fields_indicated: true
          description: "Validate form accessibility features"

  - name: "color_and_contrast_testing"
    description: "Test color contrast and visual accessibility"
    priority: "medium"
    allure:
      epic: "Accessibility"
      feature: "Color and Contrast"
      story: "As a user with visual impairments, I want sufficient color contrast"
      severity: "normal"
    
    execution:
      sample_pages: 3  # Test representative sample
      steps:
        - action: "test_color_contrast"
          standards:
            - normal_text: "4.5:1"  # WCAG AA
            - large_text: "3:1"     # WCAG AA
            - ui_components: "3:1"   # WCAG AA
          elements:
            - "body text"
            - "headings"
            - "links"
            - "buttons"
            - "form fields"
          description: "Test color contrast ratios"
        
        - action: "test_color_dependency"
          checks:
            - information_not_color_only: true
            - error_indication_methods: "multiple"
            - required_field_indication: "not_color_only"
          description: "Ensure information is not conveyed by color alone"
        
        - action: "test_focus_indicators"
          focus_checks:
            - focus_visible: true
            - focus_contrast: "3:1"
            - focus_area_adequate: true
            - custom_focus_styles: "evaluated"
          description: "Test focus indicator visibility and contrast"

assertions:
  critical:
    - "No critical accessibility violations (axe-core)"
    - "No serious accessibility violations (axe-core)"
    - "All pages are keyboard navigable"
    - "Proper heading structure exists"
  
  normal:
    - "ARIA landmarks are properly implemented"
    - "Forms are accessible to screen readers"
    - "Color contrast meets WCAG AA standards"
    - "Focus indicators are visible"
  
  minor:
    - "Skip links are available where appropriate"
    - "ARIA attributes are used correctly"
    - "Moderate accessibility issues are minimal"

error_handling:
  accessibility_scan_errors:
    - continue_on_scan_timeout: true
    - log_scan_failures: true
    - retry_with_longer_timeout: true
  
  keyboard_testing_errors:
    - handle_focus_traps_gracefully: true
    - continue_on_navigation_failure: true
    - log_keyboard_issues: true

integration:
  allure_reporting:
    attach_accessibility_report: true
    include_violation_screenshots: true
    wcag_guidelines_reference: true
  
  axe_core_integration:
    use_latest_rules: true
    include_best_practices: false  # Focus on WCAG compliance
    generate_detailed_reports: true
  
  wordpress_accessibility:
    test_wp_accessibility_features: true
    validate_theme_accessibility: true
    check_plugin_accessibility_impact: true