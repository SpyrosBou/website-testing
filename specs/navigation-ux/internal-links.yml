# Internal Links Testing Specification
# Validates internal link functionality and prevents broken navigation

metadata:
  category: "navigation-ux"
  version: "1.0.0"
  description: "Validates internal link functionality and navigation integrity"
  priority: "high"
  dependencies: ["test-helpers", "site-loader"]
  tags:
    - "link-validation"
    - "navigation"
    - "user-experience"

configuration:
  timeout: 30000
  retries: 2
  parallel: true
  browsers: ["chrome", "firefox", "safari"]
  rate_limiting:
    delay_between_requests: 500  # Prevent overwhelming the server
    max_concurrent_checks: 5

test_cases:
  - name: "internal_link_validation"
    description: "Validate all internal links are functional and accessible"
    priority: "high"
    reporting:
      epic: "Navigation & UX"
      feature: "Internal Link Validation"
      story: "As a user, I want all internal links to work correctly"
      severity: "normal"
    
    setup:
      - action: "load_site_config"
        description: "Load site configuration"
      - action: "initialize_link_tracker"
        description: "Set up link validation tracking"
    
    execution:
      for_each_page: "{{siteConfig.testPages}}"
      conditions:
        - response_status: 200
      steps:
        - action: "navigate_safely"
          target: "{{baseUrl}}{{currentPage}}"
          description: "Navigate to {{currentPage}}"
        
        - action: "extract_internal_links"
          selectors:
            - "a[href^='/']"           # Relative paths
            - "a[href^='{{baseUrl}}']" # Absolute paths to same domain
            - "a[href^='#']"           # Anchor links
          exclude_patterns:
            - "mailto:"
            - "tel:"
            - "javascript:"
            - "#"  # Empty anchor links
            - "wp-admin"
            - "wp-login"
          max_links: 50  # Limit for performance
          description: "Extract internal links from page"
        
        - action: "validate_links_batch"
          method: "head_request"  # Faster than full GET requests
          timeout: 5000
          rate_limit: true
          description: "Validate links in batches with rate limiting"
        
        - action: "check_anchor_links"
          method: "element_exists"
          description: "Verify anchor link targets exist on page"
        
        - action: "report_link_results"
          categorize_by:
            - "working": "status 200-299"
            - "redirects": "status 300-399"
            - "broken": "status 400-599"
            - "timeout": "no response"
          description: "Categorize and report link validation results"

  - name: "navigation_menu_validation"
    description: "Validate navigation menu functionality and accessibility"
    priority: "high"
    reporting:
      epic: "Navigation & UX"
      feature: "Navigation Menu"
      story: "As a user, I want functional navigation menus"
      severity: "normal"
    
    execution:
      for_each_page: "{{siteConfig.testPages}}"
      limit: 5  # Test on representative pages
      steps:
        - action: "identify_navigation_menus"
          selectors:
            - "nav"
            - ".main-navigation"
            - ".primary-menu"
            - "#main-menu"
            - ".navbar"
            - ".menu"
          description: "Identify navigation menu elements"
        
        - action: "validate_menu_structure"
          checks:
            - has_semantic_nav: true
            - has_accessible_labels: true
            - menu_items_visible: true
            - submenu_functionality: true
          description: "Verify menu structure and accessibility"
        
        - action: "test_menu_interactions"
          interactions:
            - hover: "submenu-triggers"
            - click: "menu-items"
            - keyboard_navigation: true
          max_items: 10  # Limit for performance
          description: "Test menu interactions and responsiveness"
        
        - action: "validate_mobile_menu"
          viewport: "mobile"
          checks:
            - mobile_toggle_present: true
            - mobile_menu_functional: true
            - touch_interactions: true
          description: "Verify mobile menu functionality"

  - name: "breadcrumb_navigation"
    description: "Validate breadcrumb navigation where present"
    priority: "medium"
    reporting:
      epic: "Navigation & UX"
      feature: "Breadcrumb Navigation"
      story: "As a user, I want breadcrumbs to show my location"
      severity: "minor"
    
    execution:
      for_each_page: "{{siteConfig.testPages}}"
      conditions:
        - page_depth: ">1"  # Only test on non-homepage pages
      steps:
        - action: "detect_breadcrumbs"
          selectors:
            - ".breadcrumb"
            - ".breadcrumbs"
            - "[aria-label*='breadcrumb']"
            - ".woocommerce-breadcrumb"  # WooCommerce specific
          description: "Detect breadcrumb navigation elements"
        
        - action: "validate_breadcrumb_structure"
          if: "breadcrumbs_present"
          checks:
            - proper_hierarchy: true
            - current_page_indicated: true
            - links_functional: true
            - semantic_markup: true
          description: "Validate breadcrumb structure and functionality"

assertions:
  critical:
    - "No broken internal links (4xx/5xx status codes)"
    - "Navigation menus are functional"
    - "Anchor links point to existing elements"
  
  normal:
    - "All internal links respond within timeout"
    - "Mobile navigation is functional"
    - "Menu structure is semantically correct"
  
  minor:
    - "Breadcrumbs are properly structured"
    - "Submenu interactions work correctly"
    - "Keyboard navigation is functional"

error_handling:
  soft_assertions: true
  rate_limiting: true
  link_timeout_handling:
    - log_slow_links: true
    - continue_with_remaining: true
    - report_performance_impact: true
  
  error_recovery:
    - error_type: "timeout"
      action: "extend_timeout_and_retry"
      max_timeout: 10000
    - error_type: "rate_limit"
      action: "increase_delay"
      delay: 1000

integration:
  reporting_reporting:
    attach_link_report: true
    include_broken_links_summary: true
    navigation_structure_diagram: false  # Complex to generate
  
  wordpress_specific:
    handle_wp_menu_structure: true
    test_wp_nav_walker: true
    validate_wp_menu_classes: true
  
  performance_monitoring:
    track_link_check_time: true
    optimize_batch_processing: true